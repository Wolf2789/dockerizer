#!/bin/bash

#RUN apk add shadow curl
#RUN useradd -m user
#USER user
#RUN printf "#!/bin/bash\nusermod -u \\\$UID -g \\\$GID user > /dev/null 2>&1\n\\\$@" > /home/user/entrypoint && chmod +x /home/user/entrypoint
#ENTRYPOINT [ "/home/user/entrypoint" ]
read -r -d '' DOCKERFILE <<EOD
FROM node:12-alpine
RUN apk add curl
RUN curl -fsSL https://get.pulumi.com | sh && mv /root/.pulumi /usr/local/pulumi
ENV PATH="/usr/local/pulumi/bin:${PATH}"
EOD

IMAGE_TAG=pulumi:node

build() {
	echo "$DOCKERFILE" | docker build -t $IMAGE_TAG -
}

execute() {
	APP=$1
	shift
		#-e PULUMI_CONFIG_PASSPHRASE="$PULUMI_CONFIG_PASSPHRASE" \
		#--user $(id -u):$(id -g) \
	docker run -it --rm \
		-e UID=$(id -u) \
		-e GID=$(id -g) \
		-e PULUMI_CONFIG_PASSPHRASE="" \
		-w /workspace \
		-v "$PWD:/workspace" \
		-v "$HOME:/root" \
		-v "/var/run/docker.sock:/var/run/docker.sock:ro" \
		-v "/var/lib/docker:/var/lib/docker:ro" \
		--entrypoint="$APP" \
		$IMAGE_TAG \
		"$@"
}

case "$1" in
	build) build ;;
	node|npm|sh)
		execute "$@"
		;;
	*)
		execute pulumi "$@"
		;;
esac
